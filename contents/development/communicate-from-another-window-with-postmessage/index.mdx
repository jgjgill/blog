---
title: 'postMessageë¡œ ë‹¤ë¥¸ ì°½ì—ì„œ í†µì‹ í•˜ê¸°'
description: 'postMessageë¡œ ë‹¤ë¥¸ ì°½ì—ì„œ í†µì‹ í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤.'
date: '2024-04-28'
slug: 'communicate-from-another-window-with-postmessage'
thumbnail: './images/communicate-from-another-window-with-postmessage-thumbnail.png'
thumbnail_alt: 'Communicate from another window with postMessage thumbnail'
category: 'development'
type: 'post'
---

# ì–´ë–»ê²Œ ì„œë¡œ ë‹¤ë¥¸ ì°½ì—ì„œ ë°ì´í„° í†µì‹ í•  ìˆ˜ ìˆì„ê¹Œ?

<Callout>
  ğŸ’¡ postMessageë¡œ ë‹¤ë¥¸ ì°½ì—ì„œ í†µì‹ í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤. í”¼ë“œë°±ì€ ì–¸ì œë‚˜
  í™˜ì˜ì…ë‹ˆë‹¤:)
</Callout>

PASS ì¸ì¦ì„ êµ¬í˜„í•´ì•¼ í–ˆë‹¤.

ë³´í†µ PASS ì¸ì¦ ê³¼ì •ì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ìƒˆë¡œìš´ ì°½ì´ ìƒê²¨ë‚œë‹¤.

<Image
  src="https://raw.githubusercontent.com/jgjgill/blog/main/contents/development/communicate-from-another-window-with-postmessage/images/pass-auth.png"
  alt="PASS ì¸ì¦"
  width="300"
/>

ì—¬ê¸°ì„œ ìƒˆë¡œ ìƒê¸´ ì°½ì—ì„œ ì„±ê³µ í˜¹ì€ ì‹¤íŒ¨ì— ëŒ€í•œ ì‘ë‹µì„ ë°›ì•„ ì›ë˜ í˜ì´ì§€ì—ì„œ ë™ì‘ì„ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ í•„ìš”í•˜ë‹¤.

ì–´ë–»ê²Œ í•  ìˆ˜ ìˆì„ê¹Œ?

## postMessage

`postMessage`ëŠ” `Window` ê°ì²´ ê°„ì— **êµì°¨ ì¶œì²˜(cross-origin)í†µì‹ ì„ ì•ˆì „í•˜ê²Œ ì§€ì›**í•œë‹¤.

ì¼ë°˜ì ì¸ ìƒí™©ì—ì„œ ì„œë¡œ ë‹¤ë¥¸ í˜ì´ì§€ì˜ ìŠ¤í¬ë¦½íŠ¸ëŠ” **ë™ì¼ ì¶œì²˜ ì •ì±…**(SOP)ìœ¼ë¡œ ì¶œì²˜ í˜ì´ì§€ê°€ **ë™ì¼í•œ í”„ë¡œí† ì½œ, í¬íŠ¸ ë²ˆí˜¸, í˜¸ìŠ¤íŠ¸**ë¥¼ ê³µìœ í•˜ëŠ” ê²½ìš°ì—ë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.

<Image
  src="https://raw.githubusercontent.com/jgjgill/blog/main/contents/development/communicate-from-another-window-with-postmessage/images/url-structure.png"
  alt="url êµ¬ì¡°"
/>

ì—¬ê¸°ì„œ `postMessage`ëŠ” SOPë¥¼ ì•ˆì „í•˜ê²Œ ìš°íšŒí•˜ëŠ” ì œì–´ ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí•œë‹¤.

<br />

ë³´í†µ `postMessage`ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ê²½ìš°ì— ì‚¬ìš©ëœë‹¤.

- í˜ì´ì§€ì™€ í˜ì´ì§€ê°€ ìƒì„±í•œ íŒì—…
- í˜ì´ì§€ì™€ í˜ì´ì§€ ì•ˆì— ì‚½ì…í•œ `iframe`

## ì‹¤ìŠµ ì˜ˆì œ

ì½”ë“œë¡œ ë¹ ë¥´ê²Œ ì´í•´í•´ë³´ì.

ì˜ˆì œ í™˜ê²½ì€ `vite (react + ts)` , `react router dom`ì„ í™œìš©í•´ì„œ ì§„í–‰ëœë‹¤.

<br />

**main.tsx**

```ts
import React from 'react'
import ReactDOM from 'react-dom/client'
import { RouterProvider, createBrowserRouter } from 'react-router-dom'
import Parent from './parent.tsx'
import Child from './child.tsx'

const router = createBrowserRouter([
  { path: '/', element: <Parent /> },
  { path: '/child', element: <Child /> },
])

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <RouterProvider router={router} />
  </React.StrictMode>,
)
```

<br />

ë‘ê°œì˜ ê²½ë¡œë¥¼ ì§€ì •í•´ì¤€ë‹¤.

- `/` ê²½ë¡œ: ìì‹ ì°½ì„ ìƒì„±í•˜ëŠ” í˜ì´ì§€ ì—­í• 
- `/child` ê²½ë¡œ: ìì‹ ì°½ìœ¼ë¡œ ë¶€ëª¨ í˜ì´ì§€ì— ë°ì´í„° ì „ì†¡í•˜ëŠ” íŒì—… ì—­í• 

<br />

**parent.tsx**

```ts
import { useEffect, useState } from 'react'

export default function Parent() {
  const [childData, setChildData] = useState('')

  const onClick = () => {
    window.open(
      'http://localhost:5173/child', // url
      'popup test', // target
      'popup, width=400, height=600, left=100, top=100', // windowFeatures
    )
  }

  useEffect(() => {
    const childMessage = (e: MessageEvent) => {
      if (e.data.type !== 'child') {
        return
      }

      console.log('data: ', e.data)
      console.log('origin: ', e.origin)
      console.log('source: ', e.source)

      setChildData(e.data.payload)
    }

    window.addEventListener('message', childMessage)

    return () => {
      window.removeEventListener('message', childMessage)
    }
  }, [])

  return (
    <div>
      <h1>ë‚˜ëŠ” ë¶€ëª¨</h1>

      <button onClick={onClick}>ìì‹ ì°½ ì—´ê¸°</button>
      <div>ë‚˜ëŠ” ìì‹ ë°ì´í„°: {childData}</div>
    </div>
  )
}
```

<br />

`onClick` í•¨ìˆ˜ì—ëŠ” `window.open()` ë©”ì„œë“œë¥¼ í†µí•´ íŒì—… ì°½ì„ ìƒì„±í•œë‹¤.
`url`, `target`, `windowFeatures`ì— ì ì ˆí•˜ê²Œ ê°’ì„ ë„£ëŠ”ë‹¤.

<br />

`useEffect`ì—ì„œëŠ” ì´ë²¤íŠ¸ì— ëŒ€í•œ ë™ì‘ì´ ì •ì˜ëœë‹¤.
`message`ì— ëŒ€í•œ ì´ë²¤íŠ¸ë¥¼ ëŒ€ê¸°ì‹œì¼œ `postMessage`ë¡œ ì „ì†¡ëœ ì´ë²¤íŠ¸ê°€ ì „ë‹¬ëœë‹¤.

<br />

**child.tsx**

```ts
export default function Child() {
  const onChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    window.opener.postMessage({ type: 'child', payload: e.target.value }, '*')
  }

  console.log(window.opener)

  return (
    <div>
      <h1>ë‚˜ëŠ” ìì‹</h1>
      <input onChange={onChange} />
    </div>
  )
}
```

<br />

`opener` ì†ì„±ì€ `open()` í˜¹ì€ `target` ì†ì„±ì´ ìˆëŠ” ë§í¬ë¥¼ íƒìƒ‰í•˜ì—¬ ì°½ì„ ì—° ì°½ì— ëŒ€í•œ ì°¸ì¡°ë¥¼ ë°˜í™˜í•œë‹¤.

`postMessage` ë©”ì„œë“œë¥¼ í†µí•´ ë¶€ëª¨ í˜ì´ì§€ì— ë°ì´í„°ë¥¼ ì „ì†¡í•œë‹¤.

<br />

ì½˜ì†” ë° ë™ì‘ì„ ì‚´í´ë³´ì.

<br />

**ì½˜ì†”**

<Image
  src="https://raw.githubusercontent.com/jgjgill/blog/main/contents/development/communicate-from-another-window-with-postmessage/images/console-example.png"
  alt="console ì˜ˆì œ"
/>

<br />

- `data`: `postMessage`ì—ì„œ ì „ì†¡í•œ ë°ì´í„°ê°€ ì „ì†¡ëœë‹¤.
- `origin`: `postMessage`ê°€ í˜¸ì¶œë  ë•Œ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ ì°½ì˜ `origin`ì´ ì „ì†¡ëœë‹¤.
- `soruce`: ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ `window` ê°ì²´ì˜ ì°¸ì¡°ê°€ ì „ì†¡ëœë‹¤. `window.open()`ìœ¼ë¡œ ì°½ì„ ì—´ ë•Œ ì„¤ì •í•œ `popup test`ê°€ ëˆˆì— ëˆë‹¤.

<br />

**ë™ì‘**

<Video
  src="https://raw.githubusercontent.com/jgjgill/blog/main/contents/development/communicate-from-another-window-with-postmessage/videos/postmessage-example.mov"
  alt="postMessage ì˜ˆì œ"
/>

<br />

### ë³´ì•ˆ ê³ ë ¤í•˜ê¸°

ë¹„ë°€ë²ˆí˜¸ê°™ì´ ë¯¼ê°í•œ ì •ë³´ë¥¼ ì „ë‹¬í•˜ëŠ” ê²½ìš°ë„ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
ì´ë•Œ `targetOrigin`ì„ ì œí•œí•˜ëŠ” ê²ƒì´ ì¢‹ë‹¤.

í˜„ì¬ `child.tsx` ì½”ë“œì—ì„œ `postMessage`ì˜ `targetOrigin`ì„ `*`ì—ì„œ ì˜ëª»ëœ `origin url`ì¸ `http://localhost:6000`ìœ¼ë¡œ ë³€ê²½í•´ë³´ì.

<br />

**child.tsx**

```ts
const onChange = (e: React.ChangeEvent<HTMLInputElement>) => {
  window.opener.postMessage({ type: 'child', payload: e.target.value }, '*')
}
```

<br />

ê·¸ëŸ¼ ë‹¤ìŒê³¼ ê°™ì´ ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.

<Image
  src="https://raw.githubusercontent.com/jgjgill/blog/main/contents/development/communicate-from-another-window-with-postmessage/images/postmessage-targetorigin-error.png"
  alt="postMessage targetOrigin ì—ëŸ¬"
/>

ì˜¬ë°”ë¥¸ `origin`ìœ¼ë¡œ ë³€ê²½ `*`ë¡œ êµ¬ì„±í–ˆë˜ ì²˜ìŒ ë™ì‘ê³¼ ê°™ì´ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•œë‹¤.

(ì˜ˆì œì˜ ê²½ìš° `http://localhost:5173`)

<br />

ë¯¼ê°í•œ ì •ë³´ì˜ ê²½ìš° `targetOrigin`ì„ ëª…ì‹œì ìœ¼ë¡œ ì •ì˜í•´ì£¼ì.

<br />

### ë¶€ëª¨ì—ì„œë„ ìì‹ì— ë°ì´í„° ì „ì†¡í•˜ê¸°

`source`ë¥¼ í™œìš©í•˜ì—¬ ì–‘ë°©í–¥ í†µì‹ ì„ ì„¤ì •í•´ë³´ì.

ëŒ€ë¬¸ìë¡œ ë³€í™˜í•´ì„œ ìì‹ ì°½ì— ì „ë‹¬í•  ê²ƒì´ë‹¤.

<br />

**parent.tsx**

```ts
useEffect(() => {
  const childMessage = (e: MessageEvent) => {
    if (e.data.type !== 'child' || !e.source) {
      return
    }

    setChildData(e.data.payload)

    e.source.postMessage(
      { type: 'parent', payload: e.data.payload.toLocaleUpperCase() },
      { targetOrigin: e.origin },
    )
  }

  window.addEventListener('message', childMessage)

  return () => {
    window.removeEventListener('message', childMessage)
  }
}, [])
```

<br />

**child.tsx**

```ts
useEffect(() => {
  const childMessage = (e: MessageEvent) => {
    if (e.data.type !== 'parent') {
      return
    }

    console.log(e.data.payload)
  }

  window.addEventListener('message', childMessage)

  return () => {
    window.removeEventListener('message', childMessage)
  }
}, [])
```

<br />

**ë™ì‘**

<Video
  src="https://raw.githubusercontent.com/jgjgill/blog/main/contents/development/communicate-from-another-window-with-postmessage/videos/postmessage-two-way-example.mov"
  alt="postMessage ì–‘ë°©í–¥ í†µì‹  ì˜ˆì œ"
/>

ì–‘ë°©í–¥ í†µì‹ ë„ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•œë‹¤.
