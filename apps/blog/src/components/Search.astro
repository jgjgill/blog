---
import PagefindSearch from 'astro-pagefind/components/Search';
---

<div>
  <button
    id="search-toggle"
    aria-label="검색"
    class="p-1 text-muted hover:text-fg transition-colors"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <circle cx="11" cy="11" r="8"></circle>
      <path d="m21 21-4.3-4.3"></path>
    </svg>
  </button>

  <div
    id="search-modal"
    class="fixed inset-0 z-50 hidden"
    role="dialog"
    aria-modal="true"
    aria-label="검색"
  >
    <!-- Backdrop -->
    <div
      id="search-backdrop"
      class="absolute inset-0 bg-fg/20 backdrop-blur-sm"
    >
    </div>

    <!-- Panel -->
    <div
      class="relative z-10 mx-auto mt-20 w-full max-w-xl px-4 max-h-[70vh] overflow-y-auto"
    >
      <PagefindSearch
        id="pagefind-search"
        uiOptions={{ showImages: false, resetStyles: false }}
      />
    </div>
  </div>
</div>

<script>
  function close() {
    const modal = document.getElementById("search-modal");
    modal?.classList.add("hidden");
    document.body.style.overflow = "";
  }

  function initSearch() {
    const toggle = document.getElementById("search-toggle");
    const modal = document.getElementById("search-modal");
    const backdrop = document.getElementById("search-backdrop");

    if (!toggle || !modal || !backdrop) return;

    const modalEl = modal;

    function open() {
      modalEl.classList.remove("hidden");
      document.body.style.overflow = "hidden";
      const input = modalEl.querySelector<HTMLInputElement>('input[type="text"]');
      setTimeout(() => input?.focus(), 50);
    }

    toggle.addEventListener("click", open);
    backdrop.addEventListener("click", close);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") close();
    });
  }

  // 페이지 이동 시작 전에 모달 닫기
  document.addEventListener("astro:before-preparation", close);
  document.addEventListener("astro:page-load", initSearch);
</script>
